<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* KONFIGURASI BACKGROUND BIRU TERANG */
    body { 
      margin: 0;
      padding-top: 110px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #5dade2; 
      background-image: linear-gradient(180deg, #5dade2 0%, #2e86c1 100%);
      background-attachment: fixed;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* NAVBAR */
    .navbar-top { 
      background: #1b4f72; 
      backdrop-filter: blur(15px);
      padding: 12px 20px; 
      position: fixed; 
      top: 0; width: 100%; 
      z-index: 2000; 
      border-bottom: 2px solid #ffd700;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .search-input { 
      border: 1px solid #ffd700 !important; 
      border-radius: 20px !important; 
      background: rgba(255, 255, 255, 0.9) !important;
      color: #333 !important;
    }

    .main-title { 
      color: #ffd700; font-family: serif; font-weight: bold; font-size: 24px; 
      text-transform: uppercase; letter-spacing: 2px; margin: 0;
    }

    /* KARTU PRODUK UNGU */
    .product-card { 
      border: 2px solid #ffd700 !important; 
      border-radius: 20px; 
      background: #4b0082; 
      padding: 15px; 
      height: 100%; 
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      color: #ffd700; 
    }
    
    .product-img { 
      width: 100%; aspect-ratio: 1/1; object-fit: cover; 
      border-radius: 15px; margin-bottom: 12px;
      border: 1px solid #ffd700;
    }

    /* DROPDOWN SIZE - TEKS PUTIH BOLD & PANAH PUTIH BOLD */
    .form-select-sm {
      background-color: rgba(255, 255, 255, 0.1) !important;
      color: #ffffff !important; 
      font-weight: 900 !important; 
      border: 1.5px solid #ffd700 !important;
      font-size: 13px;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='white' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
      background-repeat: no-repeat !important;
      background-position: right 0.75rem center !important;
      background-size: 16px 12px !important;
    }
    .form-select-sm option { color: #000000; font-weight: normal; }

    /* STYLE HARGA GOLD */
    .price-block { margin-top: 15px; margin-bottom: 10px; }
    .price-row { display: block; font-size: 16px; color: #ffd700; margin-bottom: 4px; }
    .price-label { font-weight: 900; color: #ffd700; display: inline-block; width: 45px; }

    /* TOMBOL BELI */
    .btn-beli { 
      background: #ffd700; color: #4b0082; font-weight: bold; 
      border: none; border-radius: 10px; width: 100%; padding: 10px;
      margin-top: 10px; transition: 0.3s; text-transform: uppercase;
      font-size: 15px; letter-spacing: 1px;
    }
    .btn-beli:hover { background: white; transform: scale(1.02); }

    /* NAVBAR CART BUTTON */
    .cart-btn { background: #ffd700; color: #4b0082; padding: 6px 18px; border-radius: 50px; font-weight: bold; cursor: pointer; border: 2px solid #ffd700;}
    
    /* MODAL KERANJANG */
    .cart-modal { position: fixed; top: 0; right: -100%; width: 350px; height: 100%; background: white; transition: 0.5s; z-index: 2201; padding: 25px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    .cart-modal.active { right: 0; }
  </style>
</head>
<body>

<div class="navbar-top">
  <div style="width: 220px;">
    <input type="text" id="searchInput" class="form-control form-control-sm search-input" placeholder="Cari Koleksi..." onkeyup="filterProduk()">
  </div>
  <div class="text-center">
    <div class="main-title">TA PARFUME</div>
  </div>
  <div class="cart-btn" onclick="toggleCart()">
    <i class="fas fa-shopping-basket"></i> <span id="cartCount">0</span>
  </div>
</div>

<div class="container mb-5">
  <div id="loadingArea" class="text-center my-5">
    <div class="spinner-border text-white"></div>
    <p class="text-white mt-2 fw-bold">Menyiapkan Koleksi Mewah...</p>
  </div>
  <div class="row row-cols-2 row-cols-md-4 g-4" id="productGrid"></div>
</div>

<div id="cartSidebar" class="cart-modal">
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <h5 class="fw-bold m-0" style="color: #4b0082;">Keranjang Saya</h5>
    <button class="btn-close" onclick="toggleCart()"></button>
  </div>
  
  <input type="text" id="custNama" class="form-control mb-2" placeholder="Nama Lengkap">
  <input type="text" id="custLine" class="form-control mb-2" placeholder="ID LINE">
  <textarea id="custAlamat" class="form-control mb-3" placeholder="Alamat Pengiriman" rows="2"></textarea>
  
  <div id="cartItems" class="flex-grow-1 overflow-auto"></div>
  
  <div class="border-top pt-3 mt-auto">
    <div class="d-flex justify-content-between fw-bold mb-3">
      <span style="color: #4b0082;">Total:</span>
      <span id="grandTotal" style="color: #4b0082;">Rp 0</span>
    </div>
    <button id="btnCheckout" class="btn w-100 py-2" style="background: #4b0082; color: #ffd700; font-weight: bold; border: none;" onclick="prosesKeSheet()">SIMPAN PESANAN</button>
  </div>
</div>

<script>
  let products = [];
  let cart = [];

  window.onload = () => {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('loadingArea').style.display = 'none';
      if (Array.isArray(data)) { products = data; render(products); }
    }).getProductData();
  };

  function render(dataList) {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = dataList.map((row) => {
      const originalIdx = products.indexOf(row);
      return `
      <div class="col">
        <div class="product-card">
          <img src="${row[14]}" class="product-img" onerror="this.src='https://placehold.co/400x400?text=TA+Parfume'">
          <div class="product-title">${row[0]}</div>
          <select class="form-select form-select-sm mb-3" id="size-${originalIdx}" onchange="updatePrice(${originalIdx})">
            <option value="0">30 ml</option>
            <option value="1">35 ml</option>
            <option value="2">50 ml</option>
            <option value="3">100 ml</option>
          </select>
          
          <div class="price-block">
            <div class="price-row"><span class="price-label">IDR:</span> <span class="price-value" id="idr-${originalIdx}">Rp ${Number(row[2].replace(/\D/g,'')).toLocaleString()}</span></div>
            <div class="price-row"><span class="price-label">USD:</span> <span class="price-value">$ <span id="usd-${originalIdx}">${row[6]}</span></span></div>
            <div class="price-row"><span class="price-label">THB:</span> <span class="price-value">฿ <span id="thb-${originalIdx}">${row[10]}</span></span></div>
          </div>

          <button class="btn-beli" onclick="addToCart(${originalIdx})">BELI</button>
        </div>
      </div>`;
    }).join('');
  }

  function updatePrice(i) {
    const off = parseInt(document.getElementById(`size-${i}`).value);
    const row = products[i];
    document.getElementById(`idr-${i}`).innerText = "Rp " + Number(row[2+off].replace(/\D/g,'')).toLocaleString();
    document.getElementById(`usd-${i}`).innerText = row[6+off];
    document.getElementById(`thb-${i}`).innerText = row[10+off];
  }

  function filterProduk() {
    const val = document.getElementById('searchInput').value.toLowerCase();
    render(products.filter(p => p[0].toLowerCase().includes(val)));
  }

  function addToCart(i) {
    const sel = document.getElementById(`size-${i}`);
    const off = parseInt(sel.value);
    const row = products[i];
    const itemId = i + '-' + off;
    const existing = cart.find(c => c.id === itemId);
    if (existing) { existing.qty++; } 
    else {
      cart.push({
        id: itemId, name: row[0], size: sel.options[sel.selectedIndex].text, qty: 1,
        pIdr: Number(row[2+off].replace(/\D/g,'')), pUsd: Number(row[6+off]), pThb: Number(row[10+off])
      });
    }
    updateCartUI();
    if (!document.getElementById('cartSidebar').classList.contains('active')) toggleCart();
  }

  function updateCartUI() {
    const container = document.getElementById('cartItems');
    let total = 0;
    document.getElementById('cartCount').innerText = cart.reduce((a, b) => a + b.qty, 0);
    if (cart.length === 0) {
      container.innerHTML = '<p class="text-center text-muted my-4">Belum ada pesanan</p>';
      document.getElementById('grandTotal').innerText = "Rp 0";
      return;
    }
    container.innerHTML = cart.map((item, idx) => {
      const subIdr = item.pIdr * item.qty;
      total += subIdr;
      return `
        <div class="border-bottom py-2 small">
          <div class="d-flex justify-content-between fw-bold">
            <span style="color: #4b0082;">${item.name} (${item.size})</span>
            <span class="text-danger" style="cursor:pointer" onclick="cart.splice(${idx},1);updateCartUI()">×</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Qty: ${item.qty}</span>
            <span class="fw-bold">Rp ${subIdr.toLocaleString()}</span>
          </div>
        </div>`;
    }).join('');
    document.getElementById('grandTotal').innerText = "Rp " + total.toLocaleString();
  }

  function toggleCart() { document.getElementById('cartSidebar').classList.toggle('active'); }

  function prosesKeSheet() {
    const nama = document.getElementById('custNama').value;
    const line = document.getElementById('custLine').value;
    const alamat = document.getElementById('custAlamat').value;
    if(!nama || !line || !alamat || cart.length === 0) return alert("Mohon lengkapi formulir!");
    const btn = document.getElementById('btnCheckout');
    btn.disabled = true; btn.innerText = "Menyimpan...";
    const finalData = cart.map(item => ({
      name: item.name, size: item.size, qty: item.qty,
      totalIdr: item.pIdr * item.qty, totalUsd: item.pUsd * item.qty, totalThb: item.pThb * item.qty
    }));
    google.script.run.withSuccessHandler(() => {
      alert("Pesanan Berhasil Disimpan!");
      cart = []; updateCartUI(); toggleCart();
      btn.disabled = false; btn.innerText = "SIMPAN PESANAN";
      document.getElementById('custNama').value = "";
      document.getElementById('custLine').value = "";
      document.getElementById('custAlamat').value = "";
    }).simpanPesanan({nama, line, alamat}, finalData);
  }
</script>
</body>
</html>